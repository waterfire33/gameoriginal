<!DOCTYPE html>
<html>
<head>
    <title>Game Host</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #roomCode { font-size: 3em; font-weight: bold; color: #3498db; }
        .player-list { margin: 20px 0; }
        .player { padding: 10px; border: 1px solid #ddd; margin: 5px; }
        .host { background-color: #ffeaa7; }
    </style>
</head>
<body>
    <h1>Game Host</h1>

    <div id="createGame">
        <input type="text" id="gameName" placeholder="Game Name">
        <input type="text" id="hostName" placeholder="Your Name">
        <button onclick="createGame()">Create Game</button>
    </div>

    <div id="gameLobby" style="display: none;">
        <h2>Room Code: <span id="roomCode"></span></h2>
        <p>Players join at: <span id="joinUrl"></span></p>

        <p><strong>Rule:</strong> The <u>first player</u> to join becomes the leader.
        When at least <strong>3 players</strong> have joined, the leader can tap
        <strong>"Start Game"</strong> on their phone to begin.</p>

        <div class="player-list" id="playerList"></div>
    </div>

    <div id="gameArea" style="display: none;">
        <h2>Round <span id="currentRound"></span> of <span id="totalRounds"></span></h2>
        <div id="gameState"></div>
        <div id="timer"></div>
        <div id="results"></div>
        <div id="gameOverBanner" style="display:none; text-align:center; margin-top:100px; font-size:3em; font-weight:bold;">GAME OVER!</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let roomCode = null;
        let gameOverInterval = null;

        function createGame() {
            const gameName = document.getElementById('gameName').value;
            const playerName = document.getElementById('hostName').value;

            socket.emit('create-game', { playerName, gameName });
        }

        socket.on('game-created', (data) => {
            roomCode = data.roomCode;

            // Reset any previous GAME OVER state
            if (gameOverInterval) {
                clearInterval(gameOverInterval);
                gameOverInterval = null;
            }
            const gameOverBanner = document.getElementById('gameOverBanner');
            gameOverBanner.style.display = 'none';
            gameOverBanner.style.visibility = 'visible';

            document.getElementById('createGame').style.display = 'none';
            document.getElementById('gameLobby').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('results').innerHTML = '';
            document.getElementById('gameState').innerHTML = '';

            document.getElementById('roomCode').textContent = roomCode;
            document.getElementById('joinUrl').textContent =
                `${window.location.origin}/player.html?room=${roomCode}`;

            updateGameState(data.gameState);
        });

        socket.on('player-joined', (data) => {
            updateGameState(data.gameState);
        });

        socket.on('game-started', (data) => {
            document.getElementById('gameLobby').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            updateGameState(data);
        });

        socket.on('answer-submitted', (data) => {
            document.getElementById('gameState').innerHTML =
                `Answers remaining: ${data.answersRemaining}`;
        });

        socket.on('start-voting', (data) => {
            let html = '<h3>Voting Time!</h3>';
            data.pairs.forEach(pair => {
                html += `<div class="pair">
                    <p><strong>Question:</strong> ${pair.promptText}</p>
                    <p>${pair.player1.answer}</p>
                    <p>VS</p>
                    <p>${pair.player2.answer}</p>
                </div>`;
            });
            document.getElementById('gameState').innerHTML = html;
        });

        socket.on('show-results', (data) => {
            let html = '<h3>Results!</h3>';
            data.results.scores.forEach(score => {
                html += `<p>${score.name}: ${score.score}</p>`;
            });
            document.getElementById('results').innerHTML = html;
        });

        // Game has fully finished (after final round)
        socket.on('game-over', (data) => {
            // Clear main game area except for GAME OVER banner
            document.getElementById('gameLobby').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('gameState').innerHTML = '';
            document.getElementById('timer').innerHTML = '';
            document.getElementById('results').innerHTML = '';

            const gameOverBanner = document.getElementById('gameOverBanner');
            gameOverBanner.style.display = 'block';
            gameOverBanner.style.visibility = 'visible';

            // Make GAME OVER appear / disappear every 2 seconds
            if (gameOverInterval) {
                clearInterval(gameOverInterval);
            }
            gameOverInterval = setInterval(() => {
                gameOverBanner.style.visibility =
                    gameOverBanner.style.visibility === 'hidden' ? 'visible' : 'visible';
            }, 500);
        });

        // Start of a new round after results
        socket.on('next-round', (data) => {
            // Clear previous round's results and voting state
            document.getElementById('results').innerHTML = '';
            document.getElementById('gameState').innerHTML = '';

            // Show game area and update round info
            document.getElementById('gameArea').style.display = 'block';
            updateGameState(data);
        });

        function updateGameState(state) {
            if (state.players) {
                let html = '';
                state.players.forEach(player => {
                    const status = player.isConnected ? 'online' : 'offline';
                    const statusColor = player.isConnected ? '#2ecc71' : '#e74c3c';
                    html += `<div class="player">
                        ${player.name} (${player.score} pts)
                        ${player.isLeader ? ' - LEADER' : ''}<br>
                        <span style="color:${statusColor}; font-size:0.9em;">${status}</span>
                    </div>`;
                });
                document.getElementById('playerList').innerHTML = html;
            }

            // Always update total rounds when provided, even if round is 0
            if (typeof state.maxRounds !== 'undefined') {
                document.getElementById('totalRounds').textContent = state.maxRounds;
            }
            if (typeof state.round !== 'undefined') {
                document.getElementById('currentRound').textContent = state.round;
            }
        }
    </script>
</body>
</html>
